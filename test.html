{% extends 'base.html' %}

{% block title %}Тест{% endblock %}

{% block content %}
  <div class="card">
    <h2>Тест{% if test_set %} — {{ test_set['name'] }}{% endif %}</h2>
    <p>Уақыт: <span id="timer" class="timer">40:00</span>
      <span id="autosaveStatus" class="autosave-indicator">Сақталмады</span></p>

    <form id="testForm" method="post" action="/submit">
      {% for q in questions %}
        <fieldset class="question-fieldset">
          <legend>{{ loop.index }}. {{ q['question_text'] }}</legend>
          <label><input type="radio" name="q_{{ q['id'] }}" value="A"> {{ q['option_a'] }}</label><br>
          <label><input type="radio" name="q_{{ q['id'] }}" value="B"> {{ q['option_b'] }}</label><br>
          <label><input type="radio" name="q_{{ q['id'] }}" value="C"> {{ q['option_c'] }}</label><br>
          <label><input type="radio" name="q_{{ q['id'] }}" value="D"> {{ q['option_d'] }}</label><br>
        </fieldset>
      {% endfor %}
      <div style="margin-top:12px"><button class="btn" type="submit">Жіберу</button></div>
    </form>
  </div>

  <script>
    // 40 minutes timer (40 * 60 seconds)
    let timeLeft = 40 * 60;
    const timerEl = document.getElementById('timer');
    const form = document.getElementById('testForm');
    const autosaveStatus = document.getElementById('autosaveStatus');

    function formatTime(t) {
      const m = Math.floor(t/60).toString().padStart(2,'0');
      const s = (t%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    timerEl.textContent = formatTime(timeLeft);

    const interval = setInterval(()=>{
      timeLeft -= 1;
      timerEl.textContent = formatTime(timeLeft);
      if (timeLeft <= 60) {
        timerEl.classList.add('warning');
      }
      if (timeLeft <= 0) {
        clearInterval(interval);
        // Auto-submit when time is up
        form.submit();
      }
    }, 1000);

    // Warn on accidental navigation
    window.addEventListener('beforeunload', function (e) {
      e.preventDefault();
      e.returnValue = '';
    });

    // Autosave every N seconds
    const AUTOSAVE_INTERVAL = 20; // seconds

    function collectAnswers() {
      const data = {};
      const inputs = form.querySelectorAll('input[type=radio]');
      inputs.forEach(i => {
        if (i.checked) {
          data[i.name] = i.value;
        }
      });
      return data;
    }

    let autosaveTimer = setInterval(()=>{
      const payload = collectAnswers();
      if (Object.keys(payload).length === 0) return; // nothing to save

      autosaveStatus.textContent = 'Сақталуда...';
      autosaveStatus.classList.remove('saved');
      autosaveStatus.classList.add('saving');

      fetch('/autosave', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      }).then(resp => {
        if (resp.status === 204) {
          autosaveStatus.textContent = 'Сақталды';
          autosaveStatus.classList.remove('saving');
          autosaveStatus.classList.add('saved');
          setTimeout(()=>{
            autosaveStatus.textContent = 'Сақталды';
          }, 1200);
        } else if (resp.status === 401) {
          autosaveStatus.textContent = 'Кіру қажет';
        } else {
          autosaveStatus.textContent = 'Қате';
        }
      }).catch(()=>{
        autosaveStatus.textContent = 'Қате';
      });

    }, AUTOSAVE_INTERVAL * 1000);

  </script>
{% endblock %}
